{{ define "main" }}
<article class="post">
  <header class="post-header">
    <h1 class="post-title">{{ .Title }}</h1>
  </header>
  <div class="post-content">
    {{ .Content }}
  </div>

  <div style="margin-bottom: 20px;">
    <label for="startDateSelector" style="font-weight: bold;">选择初始计算日期: </label>
    <select id="startDateSelector" style="padding: 5px; border-radius: 4px;"></select>
  </div>

  <div id="main-chart" style="width: 100%; height:80vh; min-height: 400px;"></div>

</article>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

<script type="text/javascript">
  var waldenTheme = {{ site.Data.walden_theme | jsonify | safeJS }};
  echarts.registerTheme('walden', waldenTheme);
  
  var myChart = echarts.init(document.getElementById('main-chart'), 'walden');
  
  var datePicker = document.getElementById('startDateSelector');
  var allPerformanceData = {{ site.Data.trading_performance_v2 | jsonify | safeJS }};

  // ... calculateCumulativeReturn 和 populateDatePicker 函数保持不变 ...
  function calculateCumulativeReturn(data, startDate) {
    const startIndex = data.findIndex(item => item.date === startDate);
    if (startIndex === -1) return [];
    const relevantData = data.slice(startIndex);
    let cumulativeProduct = 1.0;
    const cumulativeData = [];
    relevantData.forEach(item => {
      const dailyReturnDecimal = item.total / 100;
      cumulativeProduct = cumulativeProduct * (1 + dailyReturnDecimal);
      cumulativeData.push({
        date: item.date,
        dailyTotal: item.total,
        cumulative: (cumulativeProduct - 1) * 100,
        trades: item.trades
      });
    });
    return cumulativeData;
  }
  function populateDatePicker() {
    allPerformanceData.forEach(item => {
      const option = document.createElement('option');
      option.value = item.date;
      option.textContent = item.date;
      datePicker.appendChild(option);
    });
  }

  function updateChart() {
    const selectedStartDate = datePicker.value;
    const chartData = calculateCumulativeReturn(allPerformanceData, selectedStartDate);
    const dates = chartData.map(item => item.date);
    const cumulativeValues = chartData.map(item => item.cumulative.toFixed(2));

    var option = {
      baseOption: {
        title: {
          text: '策略累计收益率曲线',
          left: 'center',
          textStyle: { fontWeight: 'bold', fontSize: 36, fontFamily: 'Century Gothic' }
        },
        tooltip: {
          trigger: 'axis',
          formatter: function (params) {
            const dataIndex = params[0].dataIndex;
            const dayData = chartData[dataIndex];
            if (!dayData) return;
            const cumulativeColor = dayData.cumulative >= 0 ? '#16a34a' : '#dc2626';
            const dailyColor = dayData.dailyTotal >= 0 ? '#16a34a' : '#dc2626';
            let tooltipHtml = `<strong>日期: ${dayData.date}</strong><br/>`;
            tooltipHtml += `<strong style="color: ${cumulativeColor};">累计收益率: ${dayData.cumulative.toFixed(2)}%</strong><br/>`;
            tooltipHtml += `<span style="color: ${dailyColor};">当日总盈亏: ${dayData.dailyTotal}%</span>`;
            if (dayData.trades && Object.keys(dayData.trades).length > 0) {
              tooltipHtml += '<hr style="margin: 5px 0; border-color: #aaa;">';
              tooltipHtml += '<strong>当日交易详情:</strong><br/>';
              for (const coin in dayData.trades) {
                const tradeValue = parseFloat(dayData.trades[coin]);
                const tradeColor = tradeValue >= 0 ? '#16a34a' : '#dc2626';
                tooltipHtml += `<span style="color: ${tradeColor};">${coin}: &nbsp; ${dayData.trades[coin]}</span><br/>`;
              }
            }
            return tooltipHtml;
          }
        },
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
        toolbox: {
          feature: {
            dataZoom: { yAxisIndex: 'none' },
            restore: {},
            saveAsImage: {}
          }
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: dates,
          axisLabel: {
            fontWeight: 'bold',
            fontSize: 18,
            fontFamily: 'Century Gothic',
            formatter: function (value) {
                if (typeof value === 'string' && value.length > 0) {
                    let parts = value.split('.');
                    if (parts.length === 3) { return parts[1] + '.' + parts[2]; }
                    parts = value.split('-');
                    if (parts.length === 3) { return parts[1] + '-' + parts[2]; }
                }
                return value;
            }
          }
        },
        yAxis: {
          type: 'value',
          axisLabel: { formatter: '{value} %', fontWeight: 'bold', fontSize: 36, fontFamily: 'Century Gothic' },
          min: -20,
          max: 100
        },
        dataZoom: [ { type: 'inside' }, { start: 0, end: 100 } ],
        series: [
          {
            name: '累计收益率',
            type: 'line',
            smooth: false,
            symbol: 'none',
            lineStyle: { width: 10 },
            data: cumulativeValues,
          }
        ]
      },
      media: [
        {
          query: {
            maxWidth: 768
          },
          option: {
            title: {
              textStyle: {
                fontSize: 16
              }
            },
            toolbox: {
              show: false
            },
            xAxis: {
              axisLabel: {
                fontSize: 14
              }
            },
            yAxis: {
              axisLabel: {
                fontSize: 18
              }
            },
            series: [
              {
                lineStyle: {
                  width: 5
                }
              }
            ]
          }
        }
      ]
    };
    
    myChart.setOption(option);
  }

  populateDatePicker();
  datePicker.addEventListener('change', updateChart);
  updateChart();

  window.addEventListener('resize', function() {
    myChart.resize();
  });
</script>
{{ end }}